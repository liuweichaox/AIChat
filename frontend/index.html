<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>语音助手 / Voice Assistant</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/vue@3"></script>
  <script src="https://unpkg.com/naive-ui"></script>
  <script src="https://unpkg.com/@vicons/ionicons5"></script>
  <script src="/static/app.js"></script>
</head>

<body>
  <div id="app">
    <n-layout>
      <n-layout-header class="header-bar">
        <span class="title">{{ lang === 'zh' ? '语音助手' : 'Voice Assistant' }}</span>
        <div style="display: flex; align-items: center;">
          <n-button quaternary circle class="icon-btn" @click="toggleTTS"
            :aria-label="lang==='zh' ? (ttsMuted ? '取消静音' : '静音') : (ttsMuted ? 'Unmute' : 'Mute')"
            :title="lang==='zh' ? (ttsMuted ? '取消静音' : '静音') : (ttsMuted ? 'Unmute' : 'Mute')">
            <template #icon>
              <n-icon v-if="!ttsMuted"><VolumeHighOutline /></n-icon>
              <n-icon v-else><VolumeMuteOutline /></n-icon>
            </template>
          </n-button>
          <n-select v-model:value="lang" class="lang-selector" :options="langOptions" />
          <n-select v-model:value="voice" class="voice-selector" @update:value="onVoiceChange" :options="voiceOptions" />
        </div>
      </n-layout-header>

      <n-layout-content class="main-pane" :class="{ 'video-mode': videoEnabled }">
        <div class="video-box" v-if="videoEnabled">
          <video ref="localVideo" class="local-video" autoplay muted playsinline></video>
        </div>

        <div class="history article" ref="historyEl">
          <n-card v-for="(msg, idx) in history" :key="idx"
            :class="['message', msg.role, { playing: idx === speakingIndex }]">
            <div v-html="marked.parse(msg.text)"></div>
          </n-card>
        </div>
      </n-layout-content>

      <n-layout-footer class="chat-input-bar">
        <n-input class="chat-input" v-model:value="userInput"
          :placeholder="lang==='zh' ? '请输入你的问题...' : 'Type your question...'"
          :aria-label="lang==='zh' ? '输入' : 'Input'" @keydown.enter.exact.prevent="onSendText" />
        <n-button quaternary circle class="send-btn icon-btn" @click="onSendText"
          :aria-label="lang==='zh' ? '发送' : 'Send'" :title="lang==='zh' ? '发送' : 'Send'">
          <template #icon><n-icon><SendOutline /></n-icon></template>
        </n-button>
        <n-button quaternary circle class="icon-btn" @click="toggleMic"
          :aria-label="lang==='zh' ? (recording ? '停止语音' : '语音输入') : (recording ? 'Stop Voice' : 'Voice Input')"
          :title="lang==='zh' ? (recording ? '停止语音' : '语音输入') : (recording ? 'Stop Voice' : 'Voice Input')">
          <template #icon>
            <n-icon v-if="!recording"><MicOutline /></n-icon>
            <n-icon v-else><StopCircleOutline /></n-icon>
          </template>
        </n-button>
        <n-button quaternary circle class="icon-btn" @click="toggleVideo"
          :aria-label="lang==='zh' ? (videoEnabled ? '关闭视频' : '开启视频') : (videoEnabled ? 'Stop Video' : 'Start Video')"
          :title="lang==='zh' ? (videoEnabled ? '关闭视频' : '开启视频') : (videoEnabled ? 'Stop Video' : 'Start Video')">
          <template #icon>
            <n-icon v-if="!videoEnabled"><VideocamOutline /></n-icon>
            <n-icon v-else><VideocamOffOutline /></n-icon>
          </template>
        </n-button>
      </n-layout-footer>
    </n-layout>
    <div v-if="error" class="error">Error: {{ error }}</div>
  </div>
</body>

</html>